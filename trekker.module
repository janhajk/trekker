<?php


/**
 * Implements hook_block_info().
 */
function trekker_block_info() {
  $blocks['addToMyGear']['info'] = t('Add an item to your gear');
  $blocks['addToList']['info'] = t('Add an item to user packing list');
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function trekker_block_view($delta='') {
    $block = array();
    switch($delta) {
        case 'addToMyGear' :
        // TODO: If already in my gear, then display "I own this..."
        $block['content'] = drupal_get_form('trekker_addToMyGear_form');
        break;
        case 'addToList' :
        $block['subject'] = t('Add to your Packing List');
        $block['content'] = drupal_get_form('trekker_addToList_form');
        break;
    }

    return $block;
}

/*
 * Button "Add to my gear"
 */
function trekker_addToMyGear_form($form_state) {
    $form['nid'] = array(
        '#type' => 'hidden',
        '#value' => arg(1)
    );
    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Add to my gear'),
    );
    return $form;
}

function trekker_addToMyGear_form_submit($form, &$form_state) {
    $nid = $form_state['values']['nid'];
    //$node = node_load($nid);
    if (user_access('create my_gear content')) {
        drupal_set_message('Please fill out form below to add item to your gear', 'status');
    }
    else {
        drupal_set_message('Please create account or login to create your own gear list', 'warning');
    }
    $form_state['redirect'] = 'node/add/my-gear/'.$nid;
}


function trekker_form_alter(&$form, $form_state, $form_id) {
  // Check for a particular content type's node form. Form name is [content_type_name]_node_form
  if ($form_id == 'my_gear_node_form') {
    // Add an after_build function to process when everything's complete.
    $form['#after_build'][] = 'trekker_after_build';
  }
}


/**
 * Populate node reference field in new my_gear
 */
function trekker_after_build($form, &$form_state) {
    if (arg(3)!==NULL) {
        $node = node_load(arg(3));
        $form['field_item']['und'][0]['target_id']['#value'] = $node->title.' ('.$node->nid.')';
    }
    return $form;
}



function trekker_addToList_form($form_state) {
    global $user;
    $options = array();
    $query = db_select('node', 'n');
    $header = array(
        'title' => array('data' => t('Title'), 'field' => 'n.title'),
    );
    $nids = $query
        ->fields('n', array('nid', 'title'))
        ->condition('n.uid', $user->uid, '=')
        ->condition('n.type', 'packing_list', '=')
        ->orderBy('created', 'DESC')
        ->range(0,5)
        ->execute()
        ->fetchCol();
    $nodes = node_load_multiple($nids);
    foreach($nodes as $node) {
        $options[$node->nid] = array(
            'title' => array(
                'data' => array(
                    '#type' => 'link',
                    '#title' => $node->title,
                    '#href' => 'node/' . $node->nid,
                ),
            ),
        );


    }
    $form['qty'] = array(
        '#type' => 'textfield',
        '#value' => '1'
    );
    $form['comment'] = array(
        '#type' => 'textfield',
        '#value' => ''
    );
    $form['list'] = array(
        '#type' => 'tableselect',
        '#header' => $header,
        '#options' => $options,
        '#empty' => t('No lists available.'),
        '#multiple' => false,
    );
    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Add'),
    );
    return $form;
}

function trekker_addToList_form_submit($form, &$form_state) {
    $node = new EntityDrupalWrapper('node', $form_state['values']['list']);
    drupal_set_message('<pre>'.print_r($node,1).'</pre>');
    //$node->field_reference[0]->set(463); // Note that this is a multi value field.
    //$node->field_text->set('Some Value'); // Note that this is a single value field.
    $node->save();